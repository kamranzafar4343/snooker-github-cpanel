<?php
include "includes/config.php";
include "includes/session.php";

$ref_ids = [
    'S2058870346',
    'S9506437674',
    'S9721640651',
    'S6569829783',
    'S2770451648',
    'S3412618864',
    'S5206958436',
    'S4696976448',
    'S9670025125',
    'S4065960554',
    'S1258191836',
    'S7208071120',
    'S9445804648',
    'S2632005277',
    'S5411201450',
    'S3157306952',
    'S9135217036',
    'S2270707533',
    'S8737819932',
    'S1033167021',
    'S8858792624',
    'S6447366509',
    'S4719937053',
    'S4974207318',
    'S4145965462',
    'S7434474984',
    'S7932346964',
    'S8890258421',
    'S9715596847',
    'S5134484777',
    'S4764882556',
    'S8037862205',
    'S9761010540',
    'S9268988216',
    'S2836100086',
    'S4843932492',
    'S9970340421',
    'S2223029623',
    'S4132530136',
    'S4007377973',
    'S5690057887',
    'S5624895674',
    'S1498968358',
    'S3097456576',
    'S5035654603',
    'S1775302137',
    'S1411619035',
    'S4774527718',
    'S5253505988',
    'S9642408155',
    'S4984777128',
    'S2602599167',
    'S3834245258',
    'S5370148298',
    'S4965939726',
    'S3046028412',
    'S4579419406',
    'S8087517260',
    'S5498988889',
    'S9628581578',
    'S1709877697',
    'S2614130867',
    'S2139454158',
    'S4849987176',
    'S8396162781',
    'S5080508235',
    'S1437863198',
    'S1700746932',
    'S5899645713',
    'S9802213583',
    'S9598688568',
    'S2534482775',
    'S3798254235',
    'S7621113293',
    'S6026553150',
    'S7367426916',
    'S3545819505',
    'S6944067654',
    'S9009882758',
    'S1553027006',
    'S8209049132',
    'S2666888699',
    'S1222633111',
    'S7320079664',
    'S5283905557',
    'S3328665812',
    'S2289395069',
    'S2873974125',
    'S7383404887',
    'S3546521679',
    'S2168901961',
    'S7470986596',
    'S3048192098',
    'S2136191682',
    'S8775343479',
    'S1007167838',
    'S1903580901',
    'S8950978185',
    'S2919132701',
    'S3715802032',
    'S3739299445',
    'S1822403361',
    'S1231894563',
    'S7374890953',
    'S1749502634',
    'S4175646369',
    'S9763957475',
    'S4284656881',
    'S1840044911',
    'S5146093538',
    'S7428388389',
    'S9147874626',
    'S2348077026',
    'S7697604659',
    'S6006106896',
    'S7332895445',
    'S3008349151',
    'S4101583953',
    'S3982308992',
    'S1771230835',
    'S5779248853',
    'S6056038856',
    'S8418808254',
    'S1781595720',
    'S1089367016',
    'S1122219610',
    'S6087598159',
    'S3610188909',
    'S4829042072',
    'S3785522290',
    'S3699351612',
    'S3943547276',
    'S6533841487',
    'S6222698918',
    'S9933205239',
    'S9492895349',
    'S6265871352',
    'S5766685693',
    'S7883792893',
    'S4660523770',
    'S2329372101',
    'S3761319092',
    'S6879526817',
    'S8396773977',
    'S7979105710',
    'S9877154243',
    'S8611210081',
    'S9615692630',
    'S5818850144',
    'S3266092501',
    'S4506589317',
    'S1245446220',
    'S4977156872',
    'S5276934875',
    'S7318032464',
    'S5945456063',
    'S7780660867',
    'S5608352207',
    'S8133363274',
    'S8108421785',
    'S6358327717',
    'S7066094058',
    'S2462067179',
    'S9504722213',
    'S2726805230',
    'S6195768602',
    'S8149714659',
    'S2362389422',
    'S7625448095',
    'S2549466840',
    'S8132933064',
    'S7918928424',
    'S1492043940',
    'S2029751658',
    'S4892851239',
    'S2316757109',
    'S8555963080',
    'S5093824505',
    'S5136090604',
    'S4464834967',
    'S3597498290',
    'S8368447772',
    'S7447784375',
    'S2922977888',
    'S7597756967',
    'S7773608145',
    'S9358971091',
    'S9504152631',
    'S4304244082',
    'S1642438724',
    'S3589055612',
    'S9308862507',
    'S9005048408',
    'S1328805425',
    'S9943616252',
    'S9502615804',
    'S4047884534',
    'S7020320429',
    'S4689557568',
    'S2643379244',
    'S5390419957',
    'S1932914295',
    'S7618375085',
    'S3298329411',
    'S6253711949',
    'S1128092573',
    'S1887307972',
    'S4906383612',
    'S8372435012',
    'S8698084477',
    'S1376030985',
    'S5834603966',
    'S1846855680',
    'S3473906391',
    'S3980233221',
    'S6552753063',
    'S3984625442',
    'S5403105243',
    'S4122205207',
    'S8539213659',
    'S1328347228',
    'S9424258753',
    'S6653892156',
    'S4973016030',
    'S5614228009',
    'S9974019732',
    'S5008433249',
    'S2498110054',
    'S6667782120',
    'S2407481009',
    'S3831059718',
    'S7832161665',
    'S6653608840',
    'S5117934967',
    'S4242141100',
    'S9862669966',
    'S3142061476',
    'S4587190956',
    'S2048832657',
    'S1663075044',
    'S6298663450',
    'S7185838930',
    'S3080943148',
    'S7107101916',
    'S4387366077',
    'S6559536172',
    'S1246894823',
    'S7910795648',
    'S2561147961',
    'S9428959765',
    'S7666472718',
    'S3433886914',
    'S6564760509',
    'S8959982567',
    'S5885281928',
    'S4008379143',
    'S5479826604',
    'S2105490410',
    'S6211809191',
    'S1167835511',
    'S1976243532',
    'S1881296141',
    'S4557094966',
    'S9438377520',
    'S4679654472',
    'S9453880612',
    'S4539962779',
    'S2042143815',
    'S3485428264',
    'S9698282050',
    'S1257278286',
    'S9382579567',
    'S7812606326',
    'S5755190225',
    'S6861268752',
    'S7402203816',
    'S1476786138',
    'S8725759089',
    'S6972922903',
    'S9820871876',
    'S2543172703',
    'S6484101155',
    'S3473119484',
    'S6738797684',
    'S1395259912',
    'S8687509176',
    'S6377634021',
    'S5929383893',
    'S7963785280',
    'S4341507516',
    'S1629165951',
    'S8334515439',
    'S2454235665',
    'S2860103334',
    'S4892739472',
    'S1510881552',
    'S1438886549',
    'S3767436664',
    'S6427577540',
    'S8824077708',
    'S8781527206',
    'S6805890765',
    'S5696999019',
    'S8275657961',
    'S1707286664',
    'S9115693015',
    'S5052035434',
    'S9726849399',
    'S5100146589',
    'S7272658877',
    'S6398135277',
    'S9442489800',
    'S4921642357',
    'S8768953914',
    'S9327380365',
    'S5217150743',
    'S1059835798',
    'S5317617573',
    'S9335200084',
    'S3818804191',
    'S8957403664',
    'S9606311178',
    'S1068306629',
    'S1163967122',
    'S7539226838',
    'S4709732318',
    'S4762821934',
    'S3458645502',
    'S7451483832',
    'S8204428867',
    'S3075351225',
    'S3536961530',
    'S4945335826',
    'S8135082152',
    'S5474928101',
    'S3634043756',
    'S5770509426',
    'S7221558943'
];

foreach ($ref_ids as $ref_id) {
    // Step 1: Get the trans_id from tbl_trans for this invoice_no
    $trans_result = mysqli_query($conn, "SELECT trans_id, total_amount, narration, created_by FROM tbl_trans WHERE invoice_no = '$ref_id'");

    if ($trans_row = mysqli_fetch_assoc($trans_result)) {
        $tranid = $trans_row['trans_id'];
        $amount = $trans_row['total_amount'];
        $narration = $trans_row['narration'];
        $created_by = $trans_row['created_by'];

        //fetch sale_id date
        $completed_date = mysqli_query($conn, "SELECT sale_id from tbl_sale_detail WHERE invoice_no = '$ref_id'");
        $completed_row = mysqli_fetch_assoc($completed_date);
        $sale_id = $completed_row['sale_id'];

        //fetch completed time from tbl_sale
        $completed_time = mysqli_query($conn, "SELECT completed_at from tbl_sale WHERE sale_id = '$sale_id'");
        $completed_row = mysqli_fetch_assoc($completed_time);
        $completed_date = $completed_row['completed_at'];

        //fetch customer names from tbl_sale
        $sql = mysqli_query(
            $conn,
            "SELECT d.invoice_no,
                        s.customer_name
                    FROM 
                        tbl_sale_detail d
                    INNER JOIN 
                        tbl_sale s ON d.sale_id = s.sale_id
                    WHERE 
                        d.invoice_no ='$ref_id'"
        );
        $customer_row = mysqli_fetch_assoc($sql);
        $customer_name = $customer_row['customer_name'];

        //check 1 -> cash in hand
        // $check_sql = "
        //     SELECT * FROM tbl_trans_detail 
        //     WHERE invoice_no = '$ref_id' 
        //       AND acode = '100100000'
        //        AND d_amount > 0
        //       ";

        // $check_result = mysqli_query($conn, $check_sql);

        // if ($check_result && mysqli_num_rows($check_result) == 0) {

        // check 2 -> credit custmer
        $check_sql = "
                SELECT * FROM tbl_trans_detail 
                WHERE invoice_no = '$ref_id' 
                  AND LEFT(acode, 6) = '100200' 
                  AND c_amount > 0
            ";

        $check_result = mysqli_query($conn, $check_sql);

        if ($check_result && mysqli_num_rows($check_result) == 0) {

            //query 1 -> cash in hand
            // $sql = mysqli_query($conn, "INSERT INTO tbl_trans_detail (trans_id, invoice_no, acode, d_amount, c_amount, 
            //    bill_status, narration, created_date, created_by, parent_id, numbering) 

            //            VALUES ('$tranid', '$ref_id', '100100000',  '$amount', '0.00', 'Completed',
            //            '$narration', '2025-5-12', '$created_by', '1', 'missing entry on date 12')");

            // query 2 -> credit custmer
            $sql = mysqli_query($conn, "INSERT INTO tbl_trans_detail (trans_id, invoice_no, acode, d_amount, c_amount, 
            bill_status, narration, created_date, created_by, parent_id, numbering) 

                    VALUES ('$tranid', '$ref_id', '$customer_name', '0.00', '$amount','Completed', 
                    '$narration', '$completed_date', '$created_by', '1' , 'missed entries')");
        }
    }
}
